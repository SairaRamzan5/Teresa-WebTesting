name: Playwright Tests

on: [push, pull_request]

jobs:
  test-login-approval:
    name: "Test Login Approval"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      
      - name: Debug - Show test files
        run: |
          echo "📁 Current directory: $(pwd)"
          echo "📁 Tests directory contents:"
          ls -la tests/
          echo ""
          echo "🔍 Looking for login approval test:"
          find tests/ -name "*login*" -type f
          find tests/ -name "*approval*" -type f
      
      - name: Install dependencies
        run: |
          pip install pytest playwright pytest-playwright pytest-html
      
      - name: Install Playwright browsers
        run: |
          python -m playwright install chromium
      
      - name: Check what tests are available
        run: |
          echo "🔍 Available tests in test_login_approval.py:"
          python -m pytest tests/test_login_approval.py --collect-only
      
      - name: Run Login Approval Test
        id: run-test
        run: |
          echo "🚀 Running Login Approval Test..."
          echo "=========================================="
          
          # Run the specific test file
          python -m pytest tests/test_login_approval.py \
            -v \
            --html=report.html \
            --self-contained-html \
            --timeout=300 \
            --tb=short \
            --capture=no  # Show print statements
          
          echo "=========================================="
          echo "✅ Test execution completed"
      
      - name: Check report
        run: |
          if [ -f "report.html" ]; then
            echo "✅ Report generated: report.html"
            echo "Report size: $(wc -l < report.html) lines"
          else
            echo "❌ No report generated"
            # Create dummy report
            cat > report.html << 'EOF'
            <html>
            <head><title>Test Report</title></head>
            <body>
              <h1>Test Execution Report</h1>
              <p>Tests were executed but no report was generated.</p>
              <p>Check the logs above for details.</p>
            </body>
            </html>
            EOF
          fi
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: login-approval-test-results
          path: |
            report.html
            *.png
            screenshots/
            videos/
          retention-days: 30
